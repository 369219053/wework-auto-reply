# 企业微信自动化 - 批量通过好友申请并邀请进群 (Android版)

## 📖 项目简介

本项目是基于Android AccessibilityService的企业微信自动化应用,实现批量自动化操作:
- 🤖 **批量通过好友申请** - 一次性处理所有待处理的好友申请
- ✅ **批量邀请进群** - 一次性邀请所有新添加的客户到指定群聊
- 📱 **原生Android应用** - 无需电脑,手机独立运行
- 🎯 **一键执行** - 点击按钮即可完成所有操作
- 🔧 **智能识别** - 自动识别UI元素,适配不同版本

## ✨ 核心功能

### 批量处理流程

**阶段1: 批量通过好友申请**
```
检测"新的客户"列表 → 循环处理所有好友 → 点击"查看" → 点击"通过验证" → 点击"完成" → 返回列表 → 继续下一个 → 记录所有客户名称
```

**阶段2: 批量邀请到群聊**
```
返回消息页面 → 进入群聊 → 查看全部群成员 → 添加成员 → 我的客户 → 勾选所有刚通过的客户 → 点击确定 → 完成邀请
```

### 智能特性

- ✅ **批量处理** - 一次性处理所有好友申请,无需逐个操作
- ✅ **智能检测** - 基于UI元素检测页面状态,准确可靠
- ✅ **精准定位** - 只在"今天"分组下查找客户,避免误操作
- ✅ **完整的错误处理** - 自动重试和错误恢复机制
- ✅ **详细的操作日志** - 每一步操作都有清晰的日志记录

## 🛠️ 技术栈

### Android应用 (当前版本)
- **Kotlin** - 主要开发语言
- **Android AccessibilityService** - 无障碍服务,实现UI自动化
- **SharedPreferences** - 应用间通信
- **GestureDescription** - 手势模拟,实现精准点击

### Node.js版本 (已废弃)
- **Node.js** - 主要开发语言
- **ADB** - Android调试桥,用于控制手机
- **UIAutomator** - 获取UI元素信息

## 🚀 快速开始

### 环境要求

1. **Android手机** (Android 7.0+)
2. **企业微信** (已登录)
3. **开发环境** (仅用于编译,可选):
   - Android Studio
   - JDK 11+
   - Gradle

### 安装步骤

#### 方式1: 直接安装APK (推荐)

1. **下载APK**
   - 从 `app/build/outputs/apk/debug/app-debug.apk` 获取最新版本

2. **安装应用**
   ```bash
   adb install -r app/build/outputs/apk/debug/app-debug.apk
   ```
   或直接在手机上安装APK文件

3. **开启无障碍服务**
   - 打开手机"设置" → "无障碍" → "企微自动回复"
   - 开启服务权限

4. **使用应用**
   - 打开"企微自动回复"应用
   - 输入目标群聊名称(例如: `智界Aigc客户群`)
   - 点击"开始批量处理"
   - 应用会自动打开企业微信并执行自动化流程

#### 方式2: 从源码编译

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd wework-auto-reply
   ```

2. **编译APK**
   ```bash
   export JAVA_HOME="/Applications/Android Studio.app/Contents/jbr/Contents/Home"
   ./gradlew assembleDebug
   ```

3. **安装到手机**
   ```bash
   adb install -r app/build/outputs/apk/debug/app-debug.apk
   ```

### 使用说明

1. **启动应用**
   - 打开"企微自动回复"应用
   - 确保无障碍服务已开启

2. **输入群聊名称**
   - 在输入框中输入目标群聊名称
   - 例如: `智界Aigc客户群`
   - 注意: 只需输入群聊名称,不需要包含人数

3. **开始批量处理**
   - 点击"开始批量处理"按钮
   - 应用会自动最小化并打开企业微信
   - 自动执行完整流程:
     - 批量通过所有好友申请
     - 批量邀请所有新客户到群聊

4. **查看日志**
   - 应用会显示实时操作日志
   - 可通过 `adb logcat` 查看详细调试信息:
     ```bash
     adb logcat | grep "WEWORK_DEBUG"
     ```

## 📋 配置说明

### 应用配置

应用使用SharedPreferences存储配置,主要配置项:

| 配置项 | 说明 | 存储位置 |
|--------|------|---------|
| target_group_name | 目标群聊名称 | SharedPreferences |
| should_start_batch | 是否开始批量处理 | SharedPreferences |
| start_time | 开始时间戳 | SharedPreferences |

**重要:**
- 群聊名称只需输入主要部分,例如 `智界Aigc客户群`
- 应用会自动匹配包含该名称的群聊(包括人数)

## 📚 详细文档

- [UI结构文档](./项目文档整理/UI结构文档.md)
- [调试指南](./项目文档整理/调试指南.md)

## 🎯 核心代码说明

### WeworkAutoService.kt

**主要组件:**
- `WeworkAutoService` - AccessibilityService核心服务
- `MainActivity` - 应用主界面

**核心方法:**

1. **`startBatchProcess()`** - 启动批量处理
   - 保存配置到SharedPreferences
   - 启动企业微信应用
   - 触发自动化流程

2. **`navigateToContacts()`** - 导航到通讯录
   - 查找并点击"通讯录"按钮
   - 使用智能点击策略(直接点击 → 父节点点击 → 手势点击)

3. **`openNewCustomers()`** - 打开新客户列表
   - 查找并点击"添加客户"按钮
   - 智能等待页面加载完成

4. **`processNextCustomer()`** - 处理下一个客户
   - 查找"查看"按钮
   - 点击"通过验证"
   - 点击"完成"
   - 智能等待加载完成
   - 返回列表继续处理

5. **`navigateToMessages()`** - 导航到消息页面
   - 智能检测当前页面状态
   - 自动返回到主页面
   - 点击"消息"标签

6. **`openGroupChat()`** - 打开群聊
   - 使用模糊匹配查找群聊名称
   - 支持包含人数的群聊名称

7. **`openGroupMembers()`** - 打开群成员列表
   - 查找右上角"..."按钮 (resource-id: `com.tencent.wework:id/nhi`)
   - 点击菜单按钮

8. **`clickNode()`** - 智能点击节点
   - 三层点击策略:
     1. 直接点击节点
     2. 点击可点击的父节点
     3. 使用GestureDescription手势点击

### 关键技术点

1. **智能UI元素查找**
   - `findNodeByText()` - 通过文本查找
   - `findNodeByTextExact()` - 精确文本匹配
   - `findNodeByResourceId()` - 通过resource-id查找
   - `findNodeContainingText()` - 模糊文本匹配
   - `findAllNodesByText()` - 查找所有匹配节点

2. **智能点击策略**
   - 直接点击 → 父节点点击 → 手势点击
   - 使用GestureDescription实现精准点击
   - 自动获取节点屏幕坐标

3. **智能等待机制**
   - `waitForLoadingComplete()` - 等待加载完成
   - 检测加载指示器
   - 检测页面状态变化
   - 最多等待10秒,避免无限等待

4. **状态机管理**
   - 使用ProcessState枚举管理流程状态
   - 每个状态对应一个处理方法
   - 自动状态转换和错误恢复

5. **点击"我的客户"分类标签的正确方法** ⭐
   - ❌ **错误方法**: 直接点击"我的客户"文本节点或使用坐标点击
   - ✅ **正确方法**: 点击"我的客户"分类标签的头像节点
   - **实现步骤**:
     1. 使用`findNodeByTextExact()`查找"我的客户"文本节点
     2. 向上遍历父节点,找到`resource-id="com.tencent.wework:id/cmd"`的父节点
     3. 在该父节点下查找`resource-id="com.tencent.wework:id/lmb"`的头像节点
     4. 使用`clickNode()`点击头像节点(有三层fallback机制)
   - **关键原因**:
     - 文本节点不可点击(`clickable="false"`)
     - 坐标点击在某些设备上不稳定
     - 头像节点是明确可点击的UI元素(`clickable="true"`)

6. **智能页面状态检测**
   - 点击"添加"按钮后,先检查是否已在"我的客户"页面
   - 通过查找"根据标签筛选"文本判断页面状态
   - 如果已在目标页面,直接执行下一步
   - 如果不在,点击"我的客户"分类标签并等待页面切换
   - 点击后等待3秒,再次检查页面状态
   - 如果页面未切换,自动重试

## 🔧 使用说明

### 批量处理流程

**步骤1: 准备工作**
1. 确保企业微信已登录
2. 修改 `config.json` 中的群聊名称
3. 连接手机: `adb connect 192.168.31.xxx:5555`

**步骤2: 手动导航**
1. 打开企业微信
2. 点击底部"通讯录"标签
3. 点击"添加客户"
4. 点击"新的客户"
5. 停在"新的客户"列表页面

**步骤3: 执行批量处理**
```bash
node test_batch_process.js
```

**步骤4: 查看结果**
- 脚本会自动完成所有操作
- 查看控制台日志了解处理进度
- 所有操作都会记录在 `customers.json`

### 单独测试功能

**只测试批量通过好友申请:**
```bash
# 手动操作到"新的客户"列表页面
node test_batch_process.js
# 脚本会停在批量通过完成后
```

**只测试批量邀请:**
```bash
# 修改 test_invite_batch.js 中的客户名称
node test_invite_batch.js
```

## ⚠️ 注意事项

1. **手机保持唤醒** - 确保屏幕不会自动锁定
2. **企业微信保持前台** - 不要切换到其他应用
3. **网络稳定** - 确保手机网络连接正常
4. **群聊名称准确** - 必须完全匹配,包括括号和数字
5. **手动导航到起始页面** - 脚本执行前需要手动操作到"新的客户"列表
6. **客户在"今天"分组** - 只会处理"今天"分组下的客户

## 🐛 常见问题

### 1. ADB连接失败
```bash
# 重启ADB服务
adb kill-server
adb start-server

# 无线连接
adb connect 192.168.31.xxx:5555

# 检查连接
adb devices
```

### 2. 找不到"查看"按钮
- 确认在"新的客户"列表页面
- 确认有待处理的好友申请
- 检查UI dump: `adb shell uiautomator dump /sdcard/ui.xml && adb pull /sdcard/ui.xml`

### 3. 客户未选中
- 确认客户在"今天"分组下
- 检查客户名称是否完全匹配
- 查看日志中的Y坐标范围

### 4. 邀请失败
- 检查群聊名称是否**完全匹配**(包括括号和数字)
- 确认客户已经通过好友验证
- 查看 `customers.json` 确认记录

### 5. 返回页面错误
- 脚本使用UI元素检测页面状态
- 如果检测失败,手动返回到正确页面
- 查看日志中的页面检测信息

## 📅 更新日志

### V2.1 (2025-12-17)
- ✅ **修复"我的客户"点击问题** - 改为点击头像节点而非文本节点
- ✅ **智能页面状态检测** - 点击前先检查是否已在目标页面
- ✅ **自动重试机制** - 页面未切换时自动重试
- ✅ **移除回调依赖** - 不依赖GestureDescription回调,避免卡住
- ✅ **完善文档** - 详细记录正确的实现方法和关键技术点

### V2.0 (2025-12-15)
- ✅ **批量处理功能** - 一次性处理所有好友申请
- ✅ **批量邀请功能** - 一次性邀请所有新客户到群聊
- ✅ **智能页面检测** - 基于UI元素检测,更准确可靠
- ✅ **精准客户定位** - 只在"今天"分组下查找客户
- ✅ **完整的错误处理** - 自动重试和错误恢复
- ✅ **详细的操作日志** - 每一步都有清晰的日志记录

### V1.0 (2025-12-14)
- ✅ 实现自动通过好友申请
- ✅ 实现自动邀请进群
- ✅ 实现客户信息记录
- ✅ 实现智能判断邀请按钮
- ✅ 完整的错误处理机制

## 📄 许可证

MIT License
