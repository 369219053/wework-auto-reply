# 批量发送功能 - 语音输入状态问题解决方案

## 📋 问题描述

### 现象
批量发送消息到多个群聊时,只给第一个群聊发送成功,第二个群聊没有收到消息。

### 用户反馈
> "我设置的大群组为:测试群,里面有两个群聊,一个远方好物浦江活力群1,另一个是智界Aigc客户群(18),只给远方好物群发了消息,然后停止执行了"

### 测试结果
- ✅ **远方好物群聊**: 输入状态为**文字输入** → 发送成功
- ❌ **智界群聊**: 输入状态为**语音输入** → 发送失败,直接返回消息列表

---

## 🔍 问题分析

### 根本原因
企业微信的群聊输入框有两种状态:
1. **文字输入状态**: 显示EditText输入框,可以直接输入文字
2. **语音输入状态**: 显示"按住 说话"按钮,没有EditText输入框

当群聊处于**语音输入状态**时:
- `findNodeByClassName(rootNode, "android.widget.EditText")` 返回null
- 代码判断为"未找到输入框",执行`moveToNextChat()`
- 直接返回消息列表,跳过该群聊

### 技术细节

#### 语音输入状态的UI结构
```
- 语音按钮: resource-id="com.tencent.wework:id/ie5" (TextView, text="按住 说话")
- 键盘图标: resource-id="com.tencent.wework:id/gdx" (ImageView, 左下角)
- 输入框: 不存在 (被语音按钮替代)
```

#### 文字输入状态的UI结构
```
- 输入框: resource-id="com.tencent.wework:id/ie7" (EditText)
- 语音按钮: 不存在
- 键盘图标: 不存在
```

---

## ✅ 解决方案

### 核心思路
在输入文本之前,**智能检测输入状态**:
1. 查找语音按钮(id:ie5)
2. 如果找到 → 语音输入状态 → 点击键盘图标切换到文字输入
3. 如果未找到 → 文字输入状态 → 直接输入文本

### 实现代码

```kotlin
private fun inputTextMessage() {
    val rootNode = rootInActiveWindow ?: return
    
    // 检查是否是语音输入状态
    val voiceButton = findNodeByResourceId(rootNode, "com.tencent.wework:id/ie5")
    
    if (voiceButton != null) {
        // 语音输入状态,需要切换到文字输入
        val keyboardIcon = findNodeByResourceId(rootNode, "com.tencent.wework:id/gdx")
        
        if (keyboardIcon != null) {
            // 获取键盘图标的屏幕坐标
            val rect = android.graphics.Rect()
            keyboardIcon.getBoundsInScreen(rect)
            val centerX = (rect.left + rect.right) / 2
            val centerY = (rect.top + rect.bottom) / 2
            
            // 点击坐标切换到文字输入
            performGlobalClick(centerX.toFloat(), centerY.toFloat())
            
            // 等待1.5秒切换完成后再输入文本
            handler.postDelayed({
                performTextInput()
            }, 1500)
            return
        }
    }
    
    // 文字输入状态,直接输入
    handler.postDelayed({
        performTextInput()
    }, 1000)
}
```

### 关键技术点

#### 1. 使用resource-id查找节点
```kotlin
// 比文本查找更可靠,不受UI文字变化影响
val voiceButton = findNodeByResourceId(rootNode, "com.tencent.wework:id/ie5")
```

#### 2. 使用坐标点击
```kotlin
// 获取节点的屏幕坐标并点击中心点
val rect = android.graphics.Rect()
keyboardIcon.getBoundsInScreen(rect)
val centerX = (rect.left + rect.right) / 2
val centerY = (rect.top + rect.bottom) / 2
performGlobalClick(centerX.toFloat(), centerY.toFloat())
```

#### 3. 等待切换完成
```kotlin
// 切换需要时间,等待1.5秒确保切换完成
handler.postDelayed({
    performTextInput()
}, 1500)
```

---

## 🚨 调试过程中的坑

### 坑1: sendLog()导致流程中断
**问题**: `sendLog()`方法使用`sendBroadcast()`,但是没有注册BroadcastReceiver,导致抛出异常,中断执行流程。

**解决**: 移除所有`sendLog()`和`updateProgress()`调用,只使用`android.util.Log.e()`记录日志。

### 坑2: 日志级别导致日志不显示
**问题**: 使用`Log.d()`记录日志,在某些情况下可能不显示。

**解决**: 统一使用`android.util.Log.e()`记录关键日志,确保能显示。

### 坑3: try-catch过度使用
**问题**: 在多个地方添加try-catch,导致异常被吞掉,无法定位问题。

**解决**: 简化代码结构,只在必要的地方使用try-catch,并且在catch块中打印详细的异常信息。

---

## 📊 测试结果

### 测试场景
- **大群组**: 测试群
- **群聊1**: 远方好物浦江活力群1 (文字输入状态)
- **群聊2**: 智界Aigc客户群(18) (语音输入状态)

### 测试结果
- ✅ 群聊1: 发送成功
- ✅ 群聊2: 检测到语音输入状态 → 切换到文字输入 → 发送成功
- ✅ 批量发送完成

---

## 💡 经验总结

1. **AccessibilityService开发要充分测试各种UI状态**
   - 不同的群聊可能有不同的输入状态
   - 需要智能检测并适配

2. **日志系统要简单可靠**
   - 不要使用复杂的日志传递机制(如Broadcast)
   - 直接使用android.util.Log即可

3. **异常处理要适度**
   - 不要过度使用try-catch
   - 让异常暴露出来,便于调试

4. **延迟时间要充足**
   - UI切换需要时间
   - 延迟时间宁可长一点,确保操作完成

---

**问题解决时间**: 2025-12-18  
**解决者**: 小牛马 🐂

