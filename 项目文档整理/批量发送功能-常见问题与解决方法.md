# æ‰¹é‡å‘é€åŠŸèƒ½ - å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ³•

## ğŸ“‹ ç›®å½•

1. [å‘é€æŒ‰é’®ç‚¹å‡»é—®é¢˜](#å‘é€æŒ‰é’®ç‚¹å‡»é—®é¢˜)
2. [è”ç³»äººæŸ¥æ‰¾é—®é¢˜](#è”ç³»äººæŸ¥æ‰¾é—®é¢˜)
3. [å¤šé€‰æ¨¡å¼æ»šåŠ¨é—®é¢˜](#å¤šé€‰æ¨¡å¼æ»šåŠ¨é—®é¢˜)
4. [é€æ¡è½¬å‘æŒ‰é’®ç‚¹å‡»é—®é¢˜](#é€æ¡è½¬å‘æŒ‰é’®ç‚¹å‡»é—®é¢˜)
5. [åŠŸèƒ½äºŒæ‰§è¡ŒåŠŸèƒ½ä¸€è„šæœ¬é—®é¢˜](#åŠŸèƒ½äºŒæ‰§è¡ŒåŠŸèƒ½ä¸€è„šæœ¬é—®é¢˜)
6. [æ¶ˆæ¯èŠ‚ç‚¹è¯†åˆ«é—®é¢˜](#æ¶ˆæ¯èŠ‚ç‚¹è¯†åˆ«é—®é¢˜)
7. [ç¬¬äºŒæ¬¡æ‰§è¡Œè„šæœ¬å¤±è´¥é—®é¢˜](#ç¬¬äºŒæ¬¡æ‰§è¡Œè„šæœ¬å¤±è´¥é—®é¢˜)
8. [æ™ºèƒ½è¯†åˆ«æ¶ˆæ¯é¡µé¢ä¼˜åŒ–](#æ™ºèƒ½è¯†åˆ«æ¶ˆæ¯é¡µé¢ä¼˜åŒ–)

---

## ğŸ”§ å‘é€æŒ‰é’®ç‚¹å‡»é—®é¢˜

### é—®é¢˜æè¿°

åœ¨å‘é€ç¡®è®¤å¼¹çª—ä¸­,ç‚¹å‡»"å‘é€"æŒ‰é’®æ—¶,`clickNode()`è¿”å›`true`ä½†å®é™…æ²¡æœ‰ç‚¹å‡»æˆåŠŸã€‚

### é—®é¢˜åŸå› 

1. **é”™è¯¯çš„èŠ‚ç‚¹æŸ¥æ‰¾**: ä½¿ç”¨`findNodeContainingText(rootNode, "å‘é€")`ä¼šæ‰¾åˆ°é”™è¯¯çš„èŠ‚ç‚¹
   - æ‰¾åˆ°çš„æ˜¯"å‘é€ç»™ï¼š"æ ‡é¢˜æ–‡æœ¬,è€Œä¸æ˜¯"å‘é€"æŒ‰é’®
   - æ ‡é¢˜æ–‡æœ¬èŠ‚ç‚¹ä¸å¯ç‚¹å‡»

2. **ç‚¹å‡»æ–¹æ³•ä¸å¯é **: `clickNode()`åœ¨æŸäº›æƒ…å†µä¸‹è¿”å›`true`ä½†å®é™…æ²¡æœ‰è§¦å‘ç‚¹å‡»

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: ç²¾ç¡®æŸ¥æ‰¾æŒ‰é’®èŠ‚ç‚¹ âœ…

ä½¿ç”¨`resource-id`ç²¾ç¡®æŸ¥æ‰¾"å‘é€"æŒ‰é’®:

```kotlin
// âŒ é”™è¯¯æ–¹æ³•
val sendButton = findNodeContainingText(rootNode, "å‘é€")

// âœ… æ­£ç¡®æ–¹æ³•
val sendButton = findNodeByResourceId(rootNode, "com.tencent.wework:id/dbo")
```

#### æ–¹æ¡ˆ2: åŒé‡ç‚¹å‡»ç­–ç•¥ âœ…

å®ç°ä¸»æ–¹æ³•+å¤‡ç”¨æ–¹æ¡ˆçš„åŒé‡ä¿é™©:

```kotlin
// æ–¹æ³•1: performAction(ACTION_CLICK) - ä¼˜å…ˆå°è¯•
val actionClicked = confirmButton.performAction(AccessibilityNodeInfo.ACTION_CLICK)

if (actionClicked) {
    // ç­‰å¾…500msæ£€æŸ¥å¼¹çª—æ˜¯å¦å…³é—­
    handler.postDelayed({
        val stillHasDialog = rootNode?.let { 
            findNodeByResourceId(it, "com.tencent.wework:id/dbo") != null 
        } ?: false
        
        if (stillHasDialog) {
            // æ–¹æ³•1å¤±è´¥,ä½¿ç”¨æ–¹æ³•2: åæ ‡ç‚¹å‡»
            clickSendButtonByCoordinate(confirmButton, targetChat)
        } else {
            // æ–¹æ³•1æˆåŠŸ
            onSendSuccess(targetChat)
        }
    }, 500)
} else {
    // æ–¹æ³•1å¤±è´¥,ç›´æ¥ä½¿ç”¨æ–¹æ³•2
    clickSendButtonByCoordinate(confirmButton, targetChat)
}
```

#### æ–¹æ³•2: åæ ‡ç‚¹å‡»å®ç°

```kotlin
private fun clickSendButtonByCoordinate(confirmButton: AccessibilityNodeInfo, targetChat: String) {
    val rect = android.graphics.Rect()
    confirmButton.getBoundsInScreen(rect)
    
    val centerX = (rect.left + rect.right) / 2
    val centerY = (rect.top + rect.bottom) / 2
    
    val path = android.graphics.Path()
    path.moveTo(centerX.toFloat(), centerY.toFloat())
    
    val gestureBuilder = android.accessibilityservice.GestureDescription.Builder()
    val strokeDescription = android.accessibilityservice.GestureDescription.StrokeDescription(path, 0, 100)
    gestureBuilder.addStroke(strokeDescription)
    
    dispatchGesture(gestureBuilder.build(), object : GestureResultCallback() {
        override fun onCompleted(gestureDescription: GestureDescription?) {
            onSendSuccess(targetChat)
        }
        override fun onCancelled(gestureDescription: GestureDescription?) {
            onSendFailed(targetChat)
        }
    }, null)
}
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **ç²¾ç¡®èŠ‚ç‚¹æŸ¥æ‰¾**: ä½¿ç”¨`resource-id`è€Œä¸æ˜¯æ–‡æœ¬æŸ¥æ‰¾
2. **åŒé‡ä¿é™©**: ä¸»æ–¹æ³•å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ–¹æ¡ˆ
3. **åŠ¨æ€åæ ‡è®¡ç®—**: ä¸ç¡¬ç¼–ç åæ ‡,è€Œæ˜¯æ ¹æ®æŒ‰é’®å®é™…ä½ç½®è®¡ç®—
4. **æ™ºèƒ½éªŒè¯**: ç‚¹å‡»åæ£€æŸ¥å¼¹çª—æ˜¯å¦å…³é—­,ç¡®è®¤ç‚¹å‡»æˆåŠŸ

---

## ğŸ” è”ç³»äººæŸ¥æ‰¾é—®é¢˜

### é—®é¢˜æè¿°

åœ¨é€‰æ‹©è”ç³»äººé¡µé¢,ç¬¬äºŒä¸ªè”ç³»äºº"å¤©å¤©ä¸€æ³‰ï½å°çŸ³æ¦´"åœ¨é¡µé¢ä¸‹æ–¹ä¸å¯è§,å¯¼è‡´`findNodeContainingText()`æ‰¾ä¸åˆ°ã€‚

### é—®é¢˜åŸå› 

1. **å¯è§æ€§é™åˆ¶**: `findNodeContainingText()`åªèƒ½æŸ¥æ‰¾å½“å‰å¯è§åŒºåŸŸçš„èŠ‚ç‚¹
2. **å­—ç¬¦ç¼–ç å·®å¼‚**: æ•°æ®åº“å­˜å‚¨çš„æ˜¯åŠè§’æ³¢æµªå·`~`,é¡µé¢æ˜¾ç¤ºçš„æ˜¯å…¨è§’æ³¢æµªå·`ï½`

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: æ»šåŠ¨æŸ¥æ‰¾æœºåˆ¶ âœ…

å®ç°æ™ºèƒ½æ»šåŠ¨,ç›´åˆ°æ‰¾åˆ°ç›®æ ‡è”ç³»äººæˆ–æ»šåŠ¨åˆ°åº•éƒ¨:

```kotlin
private fun selectTargetChat(scrollAttempts: Int = 0) {
    val targetChat = groupChats[currentChatIndex]
    val rootNode = rootInActiveWindow ?: return
    
    // æŸ¥æ‰¾ç›®æ ‡è”ç³»äºº
    val chatNode = findNodeContainingText(rootNode, targetChat)
    
    if (chatNode != null) {
        // æ‰¾åˆ°äº†,ç‚¹å‡»
        clickChatNode(chatNode, targetChat)
    } else {
        // æœªæ‰¾åˆ°,å°è¯•å‘ä¸‹æ»šåŠ¨
        val scrollableNode = findScrollableNode(rootNode)
        if (scrollableNode != null) {
            val scrolled = scrollableNode.performAction(AccessibilityNodeInfo.ACTION_SCROLL_FORWARD)
            
            if (scrolled) {
                // æ»šåŠ¨æˆåŠŸ,ç­‰å¾…åç»§ç»­æŸ¥æ‰¾
                handler.postDelayed({
                    selectTargetChat(scrollAttempts + 1)
                }, 500)
            } else {
                // å·²æ»šåŠ¨åˆ°åº•éƒ¨,ä»æœªæ‰¾åˆ°
                onChatNotFound(targetChat)
            }
        } else {
            // æ‰¾ä¸åˆ°å¯æ»šåŠ¨èŠ‚ç‚¹
            onChatNotFound(targetChat)
        }
    }
}
```

#### æ–¹æ¡ˆ2: å…¨è§’/åŠè§’å­—ç¬¦æ™ºèƒ½åŒ¹é… âœ…

å®ç°æ–‡æœ¬æ ‡å‡†åŒ–,è‡ªåŠ¨å¤„ç†å…¨è§’/åŠè§’å­—ç¬¦å·®å¼‚:

```kotlin
/**
 * æ ‡å‡†åŒ–æ–‡æœ¬:å°†å…¨è§’å­—ç¬¦è½¬æ¢ä¸ºåŠè§’å­—ç¬¦,ç”¨äºæ¨¡ç³ŠåŒ¹é…
 */
private fun normalizeText(text: String): String {
    return text.map { char ->
        when (char) {
            // å…¨è§’æ³¢æµªå· â†’ åŠè§’æ³¢æµªå·
            'ï½' -> '~'
            // å…¨è§’ç©ºæ ¼ â†’ åŠè§’ç©ºæ ¼
            'ã€€' -> ' '
            // å…¨è§’æ•°å­— â†’ åŠè§’æ•°å­—
            in 'ï¼'..'ï¼™' -> (char.code - 'ï¼'.code + '0'.code).toChar()
            // å…¨è§’å­—æ¯ â†’ åŠè§’å­—æ¯
            in 'ï¼¡'..'ï¼º' -> (char.code - 'ï¼¡'.code + 'A'.code).toChar()
            in 'ï½'..'ï½š' -> (char.code - 'ï½'.code + 'a'.code).toChar()
            else -> char
        }
    }.joinToString("")
}

/**
 * æŸ¥æ‰¾åŒ…å«æŒ‡å®šæ–‡æœ¬çš„èŠ‚ç‚¹(æ”¯æŒå…¨è§’/åŠè§’æ¨¡ç³ŠåŒ¹é…)
 */
private fun findNodeContainingText(node: AccessibilityNodeInfo, text: String): AccessibilityNodeInfo? {
    val nodeText = node.text?.toString() ?: ""

    // æ ‡å‡†åŒ–åè¿›è¡Œæ¯”è¾ƒ
    val normalizedNodeText = normalizeText(nodeText)
    val normalizedSearchText = normalizeText(text)

    if (normalizedNodeText.contains(normalizedSearchText)) {
        return node
    }

    for (i in 0 until node.childCount) {
        val child = node.getChild(i) ?: continue
        val result = findNodeContainingText(child, text)
        if (result != null) return result
    }

    return null
}
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **æ»šåŠ¨æŸ¥æ‰¾**: ä½¿ç”¨`ACTION_SCROLL_FORWARD`å‘ä¸‹æ»šåŠ¨,ç›´åˆ°æ‰¾åˆ°æˆ–åˆ°åº•éƒ¨
2. **æ™ºèƒ½ç­‰å¾…**: æ»šåŠ¨åç­‰å¾…500msè®©é¡µé¢åŠ è½½å®Œæˆ
3. **é€’å½’æŸ¥æ‰¾**: æ»šåŠ¨åé€’å½’è°ƒç”¨è‡ªå·±ç»§ç»­æŸ¥æ‰¾
4. **æ–‡æœ¬æ ‡å‡†åŒ–**: è‡ªåŠ¨å¤„ç†å…¨è§’/åŠè§’å­—ç¬¦å·®å¼‚,æé«˜åŒ¹é…æˆåŠŸç‡
5. **åº•éƒ¨æ£€æµ‹**: `performAction()`è¿”å›`false`è¯´æ˜å·²åˆ°åº•éƒ¨,æ— æ³•ç»§ç»­æ»šåŠ¨

### æµ‹è¯•ç»“æœ

- âœ… æˆåŠŸæ‰¾åˆ°é¡µé¢ä¸‹æ–¹çš„è”ç³»äºº
- âœ… è‡ªåŠ¨å¤„ç†å…¨è§’/åŠè§’æ³¢æµªå·å·®å¼‚
- âœ… æ»šåŠ¨åˆ°åº•éƒ¨åæ­£ç¡®æŠ¥å‘Šæœªæ‰¾åˆ°

---

## ğŸ“œ å¤šé€‰æ¨¡å¼æ»šåŠ¨é—®é¢˜

### é—®é¢˜æè¿°

åœ¨å¤šé€‰æ¨¡å¼ä¸‹,éœ€è¦å‘ä¸Šæ»šåŠ¨åŠ è½½æ›´å¤šæ¶ˆæ¯,ä½†æ‰‹åŠ¿æ»‘åŠ¨(`input swipe`)ä¸èµ·ä½œç”¨ã€‚

### é—®é¢˜åŸå› 

ä¼ä¸šå¾®ä¿¡åœ¨å¤šé€‰æ¨¡å¼ä¸‹ç¦ç”¨äº†æ‰‹åŠ¿æ»‘åŠ¨,åªèƒ½é€šè¿‡AccessibilityServiceçš„æ»šåŠ¨Actionæ¥å®ç°ã€‚

### è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨`ACTION_SCROLL_BACKWARD`å‘ä¸Šæ»šåŠ¨:

```kotlin
private fun scrollToLoadMoreMessages() {
    val rootNode = rootInActiveWindow ?: return

    // æŸ¥æ‰¾å¯æ»šåŠ¨èŠ‚ç‚¹
    val scrollableNode = findScrollableNode(rootNode)

    if (scrollableNode != null) {
        Log.e(TAG, "âœ… æ‰¾åˆ°å¯æ»šåŠ¨èŠ‚ç‚¹,ä½¿ç”¨ACTION_SCROLL_BACKWARDæ»šåŠ¨")
        val scrolled = scrollableNode.performAction(AccessibilityNodeInfo.ACTION_SCROLL_BACKWARD)
        Log.e(TAG, "ğŸ“œ æ»šåŠ¨ç»“æœ: $scrolled")

        if (scrolled) {
            // ç­‰å¾…æ»šåŠ¨å®Œæˆåç»§ç»­å‹¾é€‰
            handler.postDelayed({
                continueSelectingMessages()
            }, 800)
        } else {
            // æ— æ³•æ»šåŠ¨,å¯èƒ½å·²ç»åˆ°é¡¶éƒ¨
            Log.e(TAG, "âš ï¸ æ— æ³•ç»§ç»­æ»šåŠ¨,å¯èƒ½å·²åˆ°é¡¶éƒ¨")
        }
    }
}

private fun findScrollableNode(node: AccessibilityNodeInfo): AccessibilityNodeInfo? {
    if (node.isScrollable) {
        return node
    }

    for (i in 0 until node.childCount) {
        val child = node.getChild(i) ?: continue
        val result = findScrollableNode(child)
        if (result != null) return result
    }

    return null
}
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **ä½¿ç”¨AccessibilityAction**: `ACTION_SCROLL_BACKWARD`å‘ä¸Šæ»šåŠ¨,`ACTION_SCROLL_FORWARD`å‘ä¸‹æ»šåŠ¨
2. **æŸ¥æ‰¾å¯æ»šåŠ¨èŠ‚ç‚¹**: é€’å½’æŸ¥æ‰¾`isScrollable=true`çš„èŠ‚ç‚¹
3. **ç­‰å¾…æ»šåŠ¨å®Œæˆ**: æ»šåŠ¨åç­‰å¾…800msè®©é¡µé¢ç¨³å®š
4. **æ£€æµ‹æ»šåŠ¨ç»“æœ**: `performAction()`è¿”å›`false`è¯´æ˜æ— æ³•ç»§ç»­æ»šåŠ¨

### ä¸ºä»€ä¹ˆä¸ç”¨æ‰‹åŠ¿æ»‘åŠ¨?

```kotlin
// âŒ è¿™ç§æ–¹æ³•åœ¨å¤šé€‰æ¨¡å¼ä¸‹ä¸èµ·ä½œç”¨
adb shell input swipe 360 1200 360 400 300

// âœ… å¿…é¡»ä½¿ç”¨AccessibilityAction
scrollableNode.performAction(AccessibilityNodeInfo.ACTION_SCROLL_BACKWARD)
```

---

## ğŸ‘† é€æ¡è½¬å‘æŒ‰é’®ç‚¹å‡»é—®é¢˜

### é—®é¢˜æè¿°

"é€æ¡è½¬å‘"æŒ‰é’®çš„`clickable="false"`,ä½¿ç”¨`clickNode()`æ— æ³•ç‚¹å‡»ã€‚

### é—®é¢˜åŸå› 

ä¼ä¸šå¾®ä¿¡çš„"é€æ¡è½¬å‘"æŒ‰é’®è™½ç„¶å¯ä»¥ç‚¹å‡»,ä½†åœ¨UIæ ‘ä¸­æ ‡è®°ä¸º`clickable="false"`,å¯¼è‡´`performAction(ACTION_CLICK)`å¤±è´¥ã€‚

### è§£å†³æ–¹æ¡ˆ

ä½¿ç”¨åæ ‡ç‚¹å‡»:

```kotlin
private fun clickOneByOneForward() {
    val rootNode = rootInActiveWindow ?: return
    val forwardButton = findNodeContainingText(rootNode, "é€æ¡è½¬å‘") ?: return

    // è·å–æŒ‰é’®åæ ‡
    val rect = android.graphics.Rect()
    forwardButton.getBoundsInScreen(rect)

    val centerX = (rect.left + rect.right) / 2
    val centerY = (rect.top + rect.bottom) / 2

    // ä½¿ç”¨æ‰‹åŠ¿ç‚¹å‡»
    val path = android.graphics.Path()
    path.moveTo(centerX.toFloat(), centerY.toFloat())

    val gestureBuilder = android.accessibilityservice.GestureDescription.Builder()
    val strokeDescription = android.accessibilityservice.GestureDescription.StrokeDescription(path, 0, 100)
    gestureBuilder.addStroke(strokeDescription)

    dispatchGesture(gestureBuilder.build(), object : GestureResultCallback() {
        override fun onCompleted(gestureDescription: GestureDescription?) {
            Log.e(TAG, "âœ… ç‚¹å‡»'é€æ¡è½¬å‘'æˆåŠŸ")
            // ç»§ç»­ä¸‹ä¸€æ­¥
        }
    }, null)
}
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **åŠ¨æ€åæ ‡è®¡ç®—**: æ ¹æ®æŒ‰é’®å®é™…ä½ç½®è®¡ç®—ä¸­å¿ƒç‚¹
2. **GestureDescription**: ä½¿ç”¨æ‰‹åŠ¿æ¨¡æ‹Ÿç‚¹å‡»
3. **å›è°ƒå¤„ç†**: åœ¨`onCompleted`ä¸­ç»§ç»­ä¸‹ä¸€æ­¥æ“ä½œ

---

## ğŸ“Š æ€»ç»“

### æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹

1. **ç²¾ç¡®èŠ‚ç‚¹æŸ¥æ‰¾**: ä¼˜å…ˆä½¿ç”¨`resource-id`,é¿å…æ–‡æœ¬æŸ¥æ‰¾çš„æ­§ä¹‰
2. **åŒé‡ä¿é™©ç­–ç•¥**: ä¸»æ–¹æ³•+å¤‡ç”¨æ–¹æ¡ˆ,æé«˜æˆåŠŸç‡
3. **æ™ºèƒ½æ»šåŠ¨æŸ¥æ‰¾**: è‡ªåŠ¨æ»šåŠ¨ç›´åˆ°æ‰¾åˆ°ç›®æ ‡æˆ–åˆ°åº•éƒ¨
4. **æ–‡æœ¬æ ‡å‡†åŒ–**: å¤„ç†å…¨è§’/åŠè§’å­—ç¬¦å·®å¼‚
5. **AccessibilityAction**: åœ¨æŸäº›åœºæ™¯ä¸‹æ¯”æ‰‹åŠ¿æ»‘åŠ¨æ›´å¯é 
6. **åŠ¨æ€åæ ‡ç‚¹å‡»**: å½“èŠ‚ç‚¹ä¸å¯ç‚¹å‡»æ—¶çš„æœ‰æ•ˆæ›¿ä»£æ–¹æ¡ˆ

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹UIç»“æ„**: `adb shell uiautomator dump && adb pull /sdcard/window_dump.xml`
2. **æŸ¥çœ‹æ—¥å¿—**: `adb logcat -d | grep "BatchSendService"`
3. **æµ‹è¯•æ»šåŠ¨**: `adb shell input swipe x1 y1 x2 y2 duration`
4. **æµ‹è¯•ç‚¹å‡»**: `adb shell input tap x y`

### æœ€ä½³å®è·µ

1. **ä¼˜å…ˆä½¿ç”¨resource-idæŸ¥æ‰¾èŠ‚ç‚¹**
2. **å®ç°å¤šå±‚fallbackæœºåˆ¶**
3. **æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º**
4. **æ™ºèƒ½ç­‰å¾…è€Œéç¡¬ç¼–ç å»¶è¿Ÿ**
5. **å¤„ç†è¾¹ç•Œæƒ…å†µ(å¦‚æ»šåŠ¨åˆ°åº•éƒ¨)**

---

## ğŸ”€ åŠŸèƒ½äºŒæ‰§è¡ŒåŠŸèƒ½ä¸€è„šæœ¬é—®é¢˜

### é—®é¢˜æè¿°

ç‚¹å‡»"åŠŸèƒ½äºŒ"çš„"å¼€å§‹æ‰¹é‡å‘é€"æŒ‰é’®å,åŒä¼å¾®é€‰æ‹©å¼¹çª—è¢«ç‚¹å‡»,ä¼å¾®æ‰“å¼€,ä½†æ˜¯æ‰§è¡Œçš„æ˜¯"åŠŸèƒ½ä¸€"çš„è„šæœ¬(å¯¼èˆªåˆ°é€šè®¯å½•ã€æ‰“å¼€æ·»åŠ å®¢æˆ·ã€æ‰“å¼€æ–°çš„å®¢æˆ·),è€Œä¸æ˜¯"åŠŸèƒ½äºŒ"çš„æ‰¹é‡å‘é€è„šæœ¬ã€‚

### é—®é¢˜åŸå› 

1. **WeworkAutoServiceå¤„ç†åŒä¼å¾®å¼¹çª—**: `WeworkAutoService`è´Ÿè´£æ£€æµ‹å¹¶ç‚¹å‡»åŒä¼å¾®é€‰æ‹©å¼¹çª—
2. **å»¶è¿Ÿå›è°ƒå¯¼è‡´å†²çª**: ç‚¹å‡»å¼¹çª—å,`WeworkAutoService`è®¾ç½®äº†3ç§’å»¶è¿Ÿå›è°ƒ,è°ƒç”¨`navigateToContacts()`(åŠŸèƒ½ä¸€çš„é€»è¾‘)
3. **æ²¡æœ‰åŒºåˆ†åŠŸèƒ½**: `WeworkAutoService`æ²¡æœ‰æ£€æŸ¥æ˜¯åŠŸèƒ½ä¸€è¿˜æ˜¯åŠŸèƒ½äºŒå¯åŠ¨,ç»Ÿä¸€æ‰§è¡ŒåŠŸèƒ½ä¸€çš„æµç¨‹

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ: æ£€æŸ¥SharedPreferencesåŒºåˆ†åŠŸèƒ½ âœ…

åœ¨`WeworkAutoService.clickWeworkByCoordinate()`ä¸­,ç‚¹å‡»å¼¹çª—åæ£€æŸ¥`shouldStartAuto`,åªæœ‰åŠŸèƒ½ä¸€æ‰è®¾ç½®å»¶è¿Ÿå›è°ƒ:

```kotlin
private fun clickWeworkByCoordinate(targetWework: String) {
    // ... ç‚¹å‡»å¼¹çª—ä»£ç  ...

    if (clicked) {
        android.util.Log.e(TAG, "âœ… ç‚¹å‡»æˆåŠŸ!")
        sendLog("âœ… å·²è‡ªåŠ¨é€‰æ‹©: $targetWework")

        // ğŸ”¥ æ£€æŸ¥æ˜¯åŠŸèƒ½ä¸€è¿˜æ˜¯åŠŸèƒ½äºŒ
        val prefsAuto = getSharedPreferences("wework_auto", android.content.Context.MODE_PRIVATE)
        val shouldStartAuto = prefsAuto.getBoolean("should_start", false)

        // åªæœ‰åŠŸèƒ½ä¸€æ‰å¯¼èˆªåˆ°é€šè®¯å½•,åŠŸèƒ½äºŒè®©BatchSendServiceæ¥ç®¡
        if (shouldStartAuto) {
            android.util.Log.e(TAG, "â° åŠŸèƒ½ä¸€å¯åŠ¨,3ç§’åå¯¼èˆªåˆ°é€šè®¯å½•")
            handler.postDelayed({
                android.util.Log.e(TAG, "â° 3ç§’å»¶è¿Ÿç»“æŸ,å¼€å§‹å¯¼èˆªåˆ°é€šè®¯å½•")
                currentState = ProcessState.NAVIGATING_TO_CONTACTS
                navigateToContacts()
            }, 3000)
        } else {
            android.util.Log.e(TAG, "â° åŠŸèƒ½äºŒå¯åŠ¨,ä¸å¯¼èˆªåˆ°é€šè®¯å½•,è®©BatchSendServiceæ¥ç®¡")
        }
    }
}
```

åŒæ—¶åœ¨`WeworkAutoService.onAccessibilityEvent()`ä¸­,æ£€æµ‹åˆ°ä¼å¾®äº‹ä»¶æ—¶,å¦‚æœæ˜¯åŠŸèƒ½äºŒå¯åŠ¨,ç›´æ¥è¿”å›,ä¸å¤„ç†:

```kotlin
// æ£€æŸ¥æ˜¯å¦éœ€è¦å¯åŠ¨æ‰¹é‡å¤„ç†(åªå¤„ç†åŠŸèƒ½ä¸€,ä¸å¤„ç†åŠŸèƒ½äºŒ)
if (!isProcessing && event.packageName == "com.tencent.wework") {
    // ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ˜¯åŠŸèƒ½äºŒå¯åŠ¨çš„
    val prefsBatch = getSharedPreferences("batch_send", android.content.Context.MODE_PRIVATE)
    val shouldStartBatch = prefsBatch.getBoolean("should_start", false)

    // å¦‚æœæ˜¯åŠŸèƒ½äºŒ,ä¸è¦å¤„ç†,è®©BatchSendServiceå¤„ç†
    if (shouldStartBatch) {
        android.util.Log.e("WEWORK_DEBUG", "âš ï¸ åŠŸèƒ½äºŒå¯åŠ¨,WeworkAutoServiceä¸å¤„ç†ä¼å¾®äº‹ä»¶")
        return
    }

    android.util.Log.e("WEWORK_DEBUG", "ğŸ” æ£€æµ‹åˆ°ä¼ä¸šå¾®ä¿¡ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å¯åŠ¨æ‰¹é‡å¤„ç†...")
    checkAndStartBatchProcess()
}
```

### å…³é”®æŠ€æœ¯ç‚¹

1. **SharedPreferencesé€šä¿¡**: ä½¿ç”¨`wework_auto`å’Œ`batch_send`ä¸¤ä¸ªç‹¬ç«‹çš„SharedPreferencesåŒºåˆ†åŠŸèƒ½
2. **æ¡ä»¶å»¶è¿Ÿå›è°ƒ**: åªæœ‰åŠŸèƒ½ä¸€æ‰è®¾ç½®å»¶è¿Ÿå›è°ƒ,åŠŸèƒ½äºŒä¸è®¾ç½®
3. **æœåŠ¡éš”ç¦»**: `WeworkAutoService`åªå¤„ç†åŠŸèƒ½ä¸€,`BatchSendService`åªå¤„ç†åŠŸèƒ½äºŒ
4. **æ—©æœŸè¿”å›**: åœ¨äº‹ä»¶å¤„ç†æ—©æœŸå°±æ£€æŸ¥å¹¶è¿”å›,é¿å…å†²çª

### æµ‹è¯•ç»“æœ

- âœ… åŠŸèƒ½ä¸€æ­£å¸¸å·¥ä½œ,ç‚¹å‡»"å¼€å§‹æ‰¹é‡å¤„ç†"åè‡ªåŠ¨å¯¼èˆªåˆ°é€šè®¯å½•
- âœ… åŠŸèƒ½äºŒæ­£å¸¸å·¥ä½œ,ç‚¹å‡»"å¼€å§‹æ‰¹é‡å‘é€"åä¸å¯¼èˆªåˆ°é€šè®¯å½•,ç”±`BatchSendService`æ¥ç®¡

---

## ğŸ“± æ¶ˆæ¯èŠ‚ç‚¹è¯†åˆ«é—®é¢˜

### é—®é¢˜æè¿°

åœ¨ç´ æåº“èŠå¤©ä¸­,`BatchSendService`æ— æ³•æ‰¾åˆ°æ¶ˆæ¯èŠ‚ç‚¹,æ—¥å¿—æ˜¾ç¤º"æ‰¾åˆ°æ¶ˆæ¯èŠ‚ç‚¹æ•°é‡: 0",å¯¼è‡´æ— æ³•é•¿æŒ‰æ¶ˆæ¯è¿›å…¥å¤šé€‰æ¨¡å¼ã€‚ç”¨æˆ·åé¦ˆ:"åªèƒ½è¯†åˆ«åˆ«äººå‘é€è¿‡æ¥çš„æ¶ˆæ¯,è‡ªå·±å‘çš„æ¶ˆæ¯è¯†åˆ«ä¸åˆ°"ã€‚

### é—®é¢˜åŸå› 

1. **resource-idä¸åŒ¹é…**: åŸä»£ç åªæŸ¥æ‰¾ä»¥ä¸‹resource-id:
   - `com.tencent.wework:id/hxd` - åˆ«äººå‘çš„æ–‡å­—æ¶ˆæ¯
   - `com.tencent.wework:id/ih3` - åˆ«äººå‘çš„å¡ç‰‡æ¶ˆæ¯
   - `com.tencent.wework:id/k2j` - å¡ç‰‡æ¶ˆæ¯ä¸­çš„å›¾ç‰‡

2. **è‡ªå·±å‘çš„æ¶ˆæ¯ç»“æ„ä¸åŒ**: é€šè¿‡UI dumpåˆ†æå‘ç°,è‡ªå·±å‘çš„æ¶ˆæ¯ä½¿ç”¨ä¸åŒçš„resource-id:
   - `com.tencent.wework:id/hwl` - è‡ªå·±å‘çš„æ¶ˆæ¯(LinearLayout, long-clickable="true")

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ: æ·»åŠ è‡ªå·±å‘çš„æ¶ˆæ¯çš„resource-id âœ…

åœ¨`findMessageNodes()`æ–¹æ³•ä¸­æ·»åŠ `com.tencent.wework:id/hwl`:

```kotlin
private fun findMessageNodes(node: AccessibilityNodeInfo?): List<AccessibilityNodeInfo> {
    val result = mutableListOf<AccessibilityNodeInfo>()
    if (node == null) return result

    // æŸ¥æ‰¾æ‰€æœ‰å¯é•¿æŒ‰çš„æ¶ˆæ¯èŠ‚ç‚¹
    // åŒ…æ‹¬: ih3, hxd (æ¶ˆæ¯å†…å®¹), k2j (å¡ç‰‡æ¶ˆæ¯ä¸­çš„å›¾ç‰‡), hwl (è‡ªå·±å‘çš„æ¶ˆæ¯)
    val resourceId = node.viewIdResourceName
    if (node.isLongClickable &&
        (resourceId == "com.tencent.wework:id/hxd" ||   // æ–‡å­—æ¶ˆæ¯(åˆ«äººå‘çš„)
         resourceId == "com.tencent.wework:id/ih3" ||   // å¡ç‰‡æ¶ˆæ¯(LinearLayout)
         resourceId == "com.tencent.wework:id/k2j" ||   // å¡ç‰‡æ¶ˆæ¯ä¸­çš„å›¾ç‰‡(ImageView)
         resourceId == "com.tencent.wework:id/hwl")) {  // ğŸ”¥ è‡ªå·±å‘çš„æ¶ˆæ¯(LinearLayout)
        result.add(node)
    }

    // é€’å½’æŸ¥æ‰¾å­èŠ‚ç‚¹
    for (i in 0 until node.childCount) {
        result.addAll(findMessageNodes(node.getChild(i)))
    }

    return result
}
```

### UIç»“æ„åˆ†æ

é€šè¿‡`adb shell uiautomator dump`åˆ†æç´ æåº“èŠå¤©é¡µé¢,å‘ç°è‡ªå·±å‘çš„æ¶ˆæ¯ç»“æ„:

```xml
<node resource-id="com.tencent.wework:id/hwl"
      class="android.widget.LinearLayout"
      long-clickable="true"
      bounds="[539,172][614,226]">
    <node resource-id="com.tencent.wework:id/idk"
          class="android.widget.TextView"
          text="1" />
</node>
```

å…³é”®ç‰¹å¾:
- `resource-id="com.tencent.wework:id/hwl"`
- `long-clickable="true"`
- åŒ…å«TextViewå­èŠ‚ç‚¹æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹

### å…³é”®æŠ€æœ¯ç‚¹

1. **UI dumpåˆ†æ**: ä½¿ç”¨`uiautomator dump`æŸ¥çœ‹å®é™…UIç»“æ„
2. **åŒºåˆ†æ¶ˆæ¯ç±»å‹**: åˆ«äººå‘çš„æ¶ˆæ¯å’Œè‡ªå·±å‘çš„æ¶ˆæ¯ä½¿ç”¨ä¸åŒçš„resource-id
3. **å®Œæ•´è¦†ç›–**: åŒæ—¶æ”¯æŒæ¥æ”¶æ¶ˆæ¯å’Œå‘é€æ¶ˆæ¯çš„è¯†åˆ«
4. **long-clickableæ£€æŸ¥**: ç¡®ä¿èŠ‚ç‚¹å¯ä»¥é•¿æŒ‰

### æµ‹è¯•ç»“æœ

- âœ… æˆåŠŸè¯†åˆ«è‡ªå·±å‘çš„æ¶ˆæ¯(æ–‡æœ¬"1", "2", "3"ç­‰)
- âœ… æˆåŠŸé•¿æŒ‰æœ€åä¸€æ¡æ¶ˆæ¯
- âœ… è¿›å…¥å¤šé€‰æ¨¡å¼

---

## ğŸ”„ ç¬¬äºŒæ¬¡æ‰§è¡Œè„šæœ¬å¤±è´¥é—®é¢˜

### é—®é¢˜æè¿°

æ‰§è¡Œå®Œä¸€æ¬¡è„šæœ¬å,å†æ¬¡æ‰§è¡Œä»»ä½•è„šæœ¬éƒ½ä¼šå¯¼è‡´æ— æ³•æ‰“å¼€ä¼å¾®ã€‚å…·ä½“è¡¨ç°:
- ç‚¹å‡»"å¼€å§‹æ‰¹é‡å‘é€"æˆ–"å¼€å§‹æ‰¹é‡å¤„ç†"
- åŒä¼å¾®é€‰æ‹©å¼¹çª—å‡ºç°
- **åº”ç”¨ç«‹å³æœ€å°åŒ–è¿”å›åˆ°æ¡Œé¢**
- å¼¹çª—æ²¡æœ‰è¢«ç‚¹å‡»,å¡åœ¨å¼¹çª—ç•Œé¢
- æ— æ³•æ‰§è¡Œè„šæœ¬

### é—®é¢˜åŸå› 

**æ ¸å¿ƒåŸå› **: `WeworkAutoService`çš„`hasClickedWeworkDialog`æ ‡å¿—åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œåè®¾ç½®ä¸º`true`,ç¬¬äºŒæ¬¡æ‰§è¡Œæ—¶æ²¡æœ‰é‡ç½®ã€‚

**è¯¦ç»†æµç¨‹åˆ†æ:**

**ç¬¬ä¸€æ¬¡æ‰§è¡Œ:**
1. ç”¨æˆ·ç‚¹å‡»"å¼€å§‹æ‰¹é‡å‘é€"
2. è®¾ç½®`SharedPreferences("batch_send", "should_start" = true, "start_time" = å½“å‰æ—¶é—´)`
3. å¯åŠ¨ä¼å¾®,å¼¹å‡ºåŒä¼å¾®å¼¹çª—
4. `WeworkAutoService`æ£€æµ‹åˆ°å¼¹çª—,`hasClickedWeworkDialog = false`
5. ç‚¹å‡»å¼¹çª—,è®¾ç½®`hasClickedWeworkDialog = true`
6. ä¼å¾®æ‰“å¼€,è„šæœ¬æ­£å¸¸æ‰§è¡Œ

**ç¬¬äºŒæ¬¡æ‰§è¡Œ(é—®é¢˜):**
1. ç”¨æˆ·å†æ¬¡ç‚¹å‡»"å¼€å§‹æ‰¹é‡å‘é€"
2. è®¾ç½®`SharedPreferences("batch_send", "should_start" = true, "start_time" = å½“å‰æ—¶é—´)`
3. å¯åŠ¨ä¼å¾®,å¼¹å‡ºåŒä¼å¾®å¼¹çª—
4. `WeworkAutoService`æ£€æµ‹åˆ°å¼¹çª—,**`hasClickedWeworkDialog = true`**(è¿˜æ˜¯ä¸Šæ¬¡çš„å€¼!)
5. **è·³è¿‡å¤„ç†å¼¹çª—**(å› ä¸ºæ ‡å¿—ä¸ºtrue)
6. æ²¡æœ‰Serviceå¤„ç†å¼¹çª—,åº”ç”¨å·²ç»æœ€å°åŒ–,å¡åœ¨å¼¹çª—ç•Œé¢

**ä¸ºä»€ä¹ˆä¼šè¿™æ ·?**
- `BatchSendService`åœ¨`startBatchSend()`ä¸­é‡ç½®äº†è‡ªå·±çš„`hasClickedWeworkDialog`
- ä½†`WeworkAutoService`çš„`hasClickedWeworkDialog`æ²¡æœ‰é‡ç½®
- åŒä¼å¾®å¼¹çª—ç”±`WeworkAutoService`å¤„ç†,æ‰€ä»¥éœ€è¦é‡ç½®`WeworkAutoService`çš„æ ‡å¿—

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ: æ£€æµ‹æ–°ä»»åŠ¡å¯åŠ¨,è‡ªåŠ¨é‡ç½®æ ‡å¿— âœ…

åœ¨`WeworkAutoService`æ£€æµ‹åˆ°åŒä¼å¾®å¼¹çª—æ—¶,æ£€æŸ¥`start_time`,å¦‚æœæ˜¯æœ€è¿‘è®¾ç½®çš„(3ç§’å†…),è¯´æ˜æ˜¯æ–°ä»»åŠ¡å¯åŠ¨,é‡ç½®`hasClickedWeworkDialog`æ ‡å¿—ã€‚

**æ ¸å¿ƒä»£ç :**

```kotlin
// ğŸ”¥ ä¼˜å…ˆå¤„ç†åŒä¼å¾®é€‰æ‹©å¼¹çª—ï¼ˆåŒæ—¶æ£€æŸ¥åŠŸèƒ½ä¸€å’ŒåŠŸèƒ½äºŒçš„SharedPreferencesï¼‰
if (event.packageName == "com.vivo.doubleinstance") {
    // æ£€æŸ¥åŠŸèƒ½ä¸€æ˜¯å¦åº”è¯¥å¯åŠ¨
    val prefsAuto = getSharedPreferences("wework_auto", android.content.Context.MODE_PRIVATE)
    val shouldStartAuto = prefsAuto.getBoolean("should_start", false)

    // æ£€æŸ¥åŠŸèƒ½äºŒæ˜¯å¦åº”è¯¥å¯åŠ¨
    val prefsBatch = getSharedPreferences("batch_send", android.content.Context.MODE_PRIVATE)
    val shouldStartBatch = prefsBatch.getBoolean("should_start", false)

    // åªæœ‰å…¶ä¸­ä¸€ä¸ªä¸ºtrueæ—¶æ‰å¤„ç†å¼¹çª—
    if (!shouldStartAuto && !shouldStartBatch) {
        return
    }

    // ğŸ”¥ æ£€æŸ¥æ˜¯å¦æ˜¯æ–°ä»»åŠ¡å¯åŠ¨,å¦‚æœæ˜¯,é‡ç½®hasClickedWeworkDialogæ ‡å¿—
    // è¿™æ ·å¯ä»¥ç¡®ä¿æ¯æ¬¡æ–°ä»»åŠ¡å¯åŠ¨æ—¶éƒ½èƒ½æ­£ç¡®å¤„ç†å¼¹çª—
    if (shouldStartAuto) {
        val startTime = prefsAuto.getLong("start_time", 0)
        val timeDiff = System.currentTimeMillis() - startTime
        if (timeDiff < 3000) {  // 3ç§’å†…è®¤ä¸ºæ˜¯æ–°ä»»åŠ¡å¯åŠ¨
            android.util.Log.e(TAG, "ğŸ”„ æ£€æµ‹åˆ°åŠŸèƒ½ä¸€æ–°ä»»åŠ¡å¯åŠ¨(timeDiff=${timeDiff}ms),é‡ç½®hasClickedWeworkDialog")
            hasClickedWeworkDialog = false
        }
    }
    if (shouldStartBatch) {
        val startTime = prefsBatch.getLong("start_time", 0)
        val timeDiff = System.currentTimeMillis() - startTime
        if (timeDiff < 3000) {  // 3ç§’å†…è®¤ä¸ºæ˜¯æ–°ä»»åŠ¡å¯åŠ¨
            android.util.Log.e(TAG, "ğŸ”„ æ£€æµ‹åˆ°åŠŸèƒ½äºŒæ–°ä»»åŠ¡å¯åŠ¨(timeDiff=${timeDiff}ms),é‡ç½®hasClickedWeworkDialog")
            hasClickedWeworkDialog = false
        }
    }

    // ğŸ”¥ åªç‚¹å‡»ä¸€æ¬¡,é¿å…é‡å¤å¤„ç†
    if (hasClickedWeworkDialog) {
        android.util.Log.e(TAG, "âš ï¸ å·²ç»ç‚¹å‡»è¿‡å¼¹çª—,è·³è¿‡")
        return
    }

    // ç‚¹å‡»å¼¹çª—...
    clickWeworkByCoordinate(weworkTarget)
    hasClickedWeworkDialog = true
}
```

### æ ¸å¿ƒæ€æƒ³(é€šä¿—è§£é‡Š)

**é—®é¢˜å°±åƒ:**
- é—¨å«(WeworkAutoService)æœ‰ä¸ªå°æœ¬æœ¬è®°å½•"ä»Šå¤©æ˜¯å¦å·²ç»å¼€è¿‡é—¨äº†"(`hasClickedWeworkDialog`)
- ç¬¬ä¸€æ¬¡å¿«é€’æ¥äº†,é—¨å«å¼€é—¨,åœ¨å°æœ¬æœ¬ä¸Šå†™"âœ“ å·²å¼€é—¨"
- ç¬¬äºŒæ¬¡å¿«é€’æ¥äº†,é—¨å«çœ‹å°æœ¬æœ¬"å·²ç»å¼€è¿‡é—¨äº†",**ä¸å¼€é—¨**
- å¿«é€’å‘˜è¢«æŒ¡åœ¨é—¨å¤–!

**è§£å†³æ–¹æ¡ˆ:**
- ç»™é—¨å«åŠ äº†ä¸ª**æ—¶é’Ÿ**
- æ¯æ¬¡å¿«é€’æ¥æ—¶,é—¨å«å…ˆçœ‹æ—¶é’Ÿ:"è¿™ä¸ªå¿«é€’æ˜¯3ç§’å†…åˆšä¸‹å•çš„å—?"
- å¦‚æœæ˜¯ â†’ **æ“¦æ‰å°æœ¬æœ¬ä¸Šçš„è®°å½•**,é‡æ–°å¼€å§‹
- é—¨å«çœ‹å°æœ¬æœ¬:"è¿˜æ²¡å¼€è¿‡é—¨" â†’ å¼€é—¨ âœ…

**æŠ€æœ¯å®ç°:**
- æ¯æ¬¡ç‚¹å‡»"å¼€å§‹æ‰¹é‡å‘é€"æ—¶,è®°å½•`start_time`(å¿«é€’ä¸‹å•æ—¶é—´)
- æ£€æµ‹åˆ°å¼¹çª—æ—¶,è®¡ç®—`timeDiff = å½“å‰æ—¶é—´ - start_time`
- å¦‚æœ`timeDiff < 3000ms` â†’ è¯´æ˜æ˜¯æ–°ä»»åŠ¡,é‡ç½®`hasClickedWeworkDialog = false`
- ç„¶åå†æ£€æŸ¥æ ‡å¿—,å†³å®šæ˜¯å¦ç‚¹å‡»å¼¹çª—

### å…³é”®æŠ€æœ¯ç‚¹

1. **æ—¶é—´æˆ³åˆ¤æ–­**: ä½¿ç”¨`start_time`åˆ¤æ–­æ˜¯å¦æ˜¯æ–°ä»»åŠ¡å¯åŠ¨
2. **3ç§’æ—¶é—´çª—å£**: ä»ç‚¹å‡»æŒ‰é’®åˆ°å¼¹çª—å‡ºç°é€šå¸¸1-2ç§’,3ç§’æ˜¯å®‰å…¨çš„æ—¶é—´çª—å£
3. **è‡ªåŠ¨é‡ç½®**: ä¸éœ€è¦æ‰‹åŠ¨é‡ç½®,ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶é‡ç½®
4. **ä¸ç ´ååŸæœ‰é€»è¾‘**:
   - åŒä¸€æ¬¡ä»»åŠ¡ä¸­,å¼¹çª—åªä¼šç‚¹å‡»ä¸€æ¬¡(3ç§’åä¸ä¼šé‡ç½®)
   - ä¸åŒä»»åŠ¡ä¹‹é—´,æ¯æ¬¡éƒ½èƒ½æ­£ç¡®å¤„ç†å¼¹çª—
5. **åŠŸèƒ½ä¸€å’ŒåŠŸèƒ½äºŒéƒ½é€‚ç”¨**: åŒæ—¶æ£€æŸ¥ä¸¤ä¸ªåŠŸèƒ½çš„`start_time`

### ä¸ºä»€ä¹ˆæ˜¯3ç§’?

- **æ­£å¸¸æµç¨‹**: ç‚¹å‡»æŒ‰é’® â†’ å¯åŠ¨ä¼å¾® â†’ å¼¹çª—å‡ºç°,é€šå¸¸1-2ç§’
- **3ç§’çª—å£**: è¶³å¤Ÿè¦†ç›–æ­£å¸¸æµç¨‹,åˆä¸ä¼šå¤ªé•¿
- **è¶…è¿‡3ç§’**: è¯´æ˜ä¸æ˜¯æ–°ä»»åŠ¡è§¦å‘çš„å¼¹çª—,ä¿æŒæ ‡å¿—ä¸å˜

### æµ‹è¯•ç»“æœ

- âœ… ç¬¬ä¸€æ¬¡æ‰§è¡Œæ­£å¸¸
- âœ… ç¬¬äºŒæ¬¡æ‰§è¡Œæ­£å¸¸,èƒ½æ­£ç¡®æ‰“å¼€ä¼å¾®
- âœ… å¤šæ¬¡æ‰§è¡Œéƒ½æ­£å¸¸
- âœ… åŠŸèƒ½ä¸€å’ŒåŠŸèƒ½äºŒéƒ½æ­£å¸¸
- âœ… ä¸ä¼šé‡å¤ç‚¹å‡»å¼¹çª—

### ç›¸å…³ä»£ç ä½ç½®

- **æ–‡ä»¶**: `WeworkAutoService.kt`
- **æ–¹æ³•**: `onAccessibilityEvent()`
- **è¡Œæ•°**: ç¬¬142-159è¡Œ

---

## ğŸ“Š æ›´æ–°æ€»ç»“

### æ–°å¢é—®é¢˜è§£å†³

1. **åŠŸèƒ½äºŒæ‰§è¡ŒåŠŸèƒ½ä¸€è„šæœ¬**: é€šè¿‡æ£€æŸ¥SharedPreferencesåŒºåˆ†åŠŸèƒ½,æ¡ä»¶è®¾ç½®å»¶è¿Ÿå›è°ƒ
2. **æ¶ˆæ¯èŠ‚ç‚¹è¯†åˆ«**: æ·»åŠ è‡ªå·±å‘çš„æ¶ˆæ¯çš„resource-idæ”¯æŒ
3. **ç¬¬äºŒæ¬¡æ‰§è¡Œè„šæœ¬å¤±è´¥**: é€šè¿‡æ—¶é—´æˆ³åˆ¤æ–­æ–°ä»»åŠ¡å¯åŠ¨,è‡ªåŠ¨é‡ç½®å¼¹çª—ç‚¹å‡»æ ‡å¿—

### æŠ€æœ¯è¦ç‚¹æ›´æ–°

1. **æœåŠ¡éš”ç¦»**: ä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒçš„AccessibilityServiceæˆ–é€šè¿‡SharedPreferencesåŒºåˆ†
2. **UIç»“æ„åˆ†æ**: ä½¿ç”¨uiautomator dumpåˆ†æå®é™…UIç»“æ„,æ‰¾åˆ°æ­£ç¡®çš„resource-id
3. **å®Œæ•´æ€§æµ‹è¯•**: æµ‹è¯•ä¸åŒåœºæ™¯(åˆ«äººå‘çš„æ¶ˆæ¯ã€è‡ªå·±å‘çš„æ¶ˆæ¯ã€ä¸åŒæ¶ˆæ¯ç±»å‹)
4. **æ—¶é—´æˆ³åˆ¤æ–­**: ä½¿ç”¨æ—¶é—´æˆ³åˆ¤æ–­ä»»åŠ¡å¯åŠ¨çŠ¶æ€,å®ç°æ™ºèƒ½é‡ç½®
5. **çŠ¶æ€ç®¡ç†**: åˆç†ç®¡ç†å…¨å±€çŠ¶æ€æ ‡å¿—,é¿å…çŠ¶æ€æ±¡æŸ“

---

## 8. æ™ºèƒ½è¯†åˆ«æ¶ˆæ¯é¡µé¢ä¼˜åŒ–

### ğŸ“‹ é—®é¢˜æè¿°

**ä¼˜åŒ–å‰çš„é—®é¢˜:**
- æ¯æ¬¡æ‰§è¡ŒåŠŸèƒ½äºŒè„šæœ¬å‰,å¿…é¡»æ‰‹åŠ¨ç¡®ä¿ä¼å¾®å¤„äº"æ¶ˆæ¯"é¡µé¢
- å¦‚æœåœ¨å…¶ä»–é¡µé¢(é€šè®¯å½•ã€å·¥ä½œå°ã€èŠå¤©è¯¦æƒ…ç­‰)å¯åŠ¨è„šæœ¬,ä¼šå¯¼è‡´è„šæœ¬æ‰§è¡Œå¤±è´¥
- ç”¨æˆ·ä½“éªŒä¸å‹å¥½,éœ€è¦é¢å¤–çš„æ‰‹åŠ¨æ“ä½œ

**ä¼˜åŒ–ç›®æ ‡:**
- æ™ºèƒ½è¯†åˆ«å½“å‰é¡µé¢çŠ¶æ€
- è‡ªåŠ¨å¯¼èˆªåˆ°æ¶ˆæ¯é¡µé¢
- æ— éœ€ç”¨æˆ·æ‰‹åŠ¨ç¡®ä¿é¡µé¢ä½ç½®

### ğŸ” é—®é¢˜åŸå› 

**åŸæœ‰é€»è¾‘:**
```kotlin
// ç›´æ¥å°è¯•æ‰“å¼€ç´ æåº“èŠå¤©,ä¸æ£€æŸ¥å½“å‰é¡µé¢
private fun navigateToMessages() {
    openMaterialChat()  // å‡è®¾å·²ç»åœ¨æ¶ˆæ¯é¡µé¢
}
```

**é—®é¢˜åˆ†æ:**
1. **æœªæ£€æµ‹å½“å‰é¡µé¢** - ä¸çŸ¥é“ç”¨æˆ·å½“å‰åœ¨å“ªä¸ªé¡µé¢
2. **æ— è‡ªåŠ¨å¯¼èˆª** - ä¸åœ¨æ¶ˆæ¯é¡µé¢æ—¶æ— æ³•è‡ªåŠ¨åˆ‡æ¢
3. **é²æ£’æ€§å·®** - åœ¨èŠå¤©è¯¦æƒ…é¡µç­‰æ·±å±‚é¡µé¢æ—¶å®Œå…¨å¤±æ•ˆ

### âœ… è§£å†³æ–¹æ¡ˆ

**æ ¸å¿ƒæ€è·¯:**
1. **æ™ºèƒ½è¯†åˆ«** - æ£€æŸ¥åº•éƒ¨å¯¼èˆªæ "æ¶ˆæ¯"æŒ‰é’®çš„`isSelected`å±æ€§
2. **è‡ªåŠ¨å¯¼èˆª** - ä¸åœ¨æ¶ˆæ¯é¡µé¢æ—¶è‡ªåŠ¨ç‚¹å‡»"æ¶ˆæ¯"æŒ‰é’®
3. **è¿”å›é‡è¯•** - æ‰¾ä¸åˆ°"æ¶ˆæ¯"æŒ‰é’®æ—¶æŒ‰è¿”å›é”®è¿”å›ä¸»é¡µé¢,ç„¶åé‡è¯•
4. **é‡è¯•æœºåˆ¶** - æœ€å¤šé‡è¯•5æ¬¡,é¿å…æ— é™å¾ªç¯

**å®ç°ä»£ç :**

<augment_code_snippet path="wework-auto-reply/app/src/main/java/com/wework/autoreply/BatchSendService.kt" mode="EXCERPT">
````kotlin
/**
 * å¯¼èˆªåˆ°æ¶ˆæ¯é¡µé¢
 * ğŸ”¥ æ™ºèƒ½è¯†åˆ«å½“å‰é¡µé¢,å¦‚æœä¸åœ¨æ¶ˆæ¯é¡µé¢åˆ™è‡ªåŠ¨å¯¼èˆª
 */
private fun navigateToMessages(retryCount: Int = 0) {
    Log.e(TAG, "ğŸ“± å¯¼èˆªåˆ°æ¶ˆæ¯é¡µé¢ (é‡è¯•æ¬¡æ•°: $retryCount/$MAX_NAVIGATE_RETRY)")
    sendLog("ğŸ“± æ£€æŸ¥å½“å‰é¡µé¢...")

    val rootNode = rootInActiveWindow ?: run {
        Log.e(TAG, "âŒ æ— æ³•è·å–çª—å£ä¿¡æ¯")
        retryOrStop()
        return
    }

    // ğŸ”¥ æŸ¥æ‰¾åº•éƒ¨å¯¼èˆªæ çš„"æ¶ˆæ¯"æŒ‰é’®
    val messagesButton = findNodeByText(rootNode, "æ¶ˆæ¯")

    if (messagesButton != null) {
        // æ‰¾åˆ°"æ¶ˆæ¯"æŒ‰é’®,è¯´æ˜åœ¨ä¸»é¡µé¢
        val isSelected = messagesButton.isSelected
        Log.e(TAG, "ğŸ” æ‰¾åˆ°æ¶ˆæ¯æŒ‰é’®, isSelected=$isSelected")

        if (isSelected) {
            // å·²ç»åœ¨æ¶ˆæ¯é¡µé¢,ç›´æ¥ç»§ç»­
            Log.e(TAG, "âœ… å·²ç»åœ¨æ¶ˆæ¯é¡µé¢,ç›´æ¥æ‰“å¼€ç´ æåº“èŠå¤©")
            sendLog("âœ… å·²åœ¨æ¶ˆæ¯é¡µé¢")
            navigateRetryCount = 0
            handler.postDelayed({
                currentState = ProcessState.OPENING_MATERIAL_CHAT
                openMaterialChat()
            }, 1000)
        } else {
            // ä¸åœ¨æ¶ˆæ¯é¡µé¢,ç‚¹å‡»"æ¶ˆæ¯"æŒ‰é’®åˆ‡æ¢
            Log.e(TAG, "âš ï¸ ä¸åœ¨æ¶ˆæ¯é¡µé¢,ç‚¹å‡»æ¶ˆæ¯æŒ‰é’®åˆ‡æ¢")
            sendLog("ğŸ“± åˆ‡æ¢åˆ°æ¶ˆæ¯é¡µé¢...")
            clickNode(messagesButton)
            navigateRetryCount = 0
            handler.postDelayed({
                currentState = ProcessState.OPENING_MATERIAL_CHAT
                openMaterialChat()
            }, 1500)
        }
    } else {
        // æ‰¾ä¸åˆ°"æ¶ˆæ¯"æŒ‰é’®,è¯´æ˜ä¸åœ¨ä¸»é¡µé¢
        if (retryCount >= MAX_NAVIGATE_RETRY) {
            Log.e(TAG, "âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°,åœæ­¢å¤„ç†")
            sendLog("âŒ æ— æ³•è¿”å›æ¶ˆæ¯é¡µé¢,è¯·æ‰‹åŠ¨è¿”å›åé‡è¯•")
            stopProcessing()
            return
        }

        // æŒ‰è¿”å›é”®è¿”å›ä¸»é¡µé¢
        Log.e(TAG, "ğŸ“± æŒ‰è¿”å›é”®è¿”å›ä¸»é¡µé¢ (ç¬¬${retryCount + 1}æ¬¡å°è¯•)")
        sendLog("ğŸ“± è¿”å›ä¸»é¡µé¢...")
        performGlobalAction(GLOBAL_ACTION_BACK)

        // ç­‰å¾…1.5ç§’åé‡è¯•
        handler.postDelayed({
            navigateToMessages(retryCount + 1)
        }, 1500)
    }
}
````
</augment_code_snippet>

### ğŸ¯ æ ¸å¿ƒæŠ€æœ¯ç‚¹

#### 1. **isSelectedå±æ€§æ£€æµ‹**
```kotlin
val isSelected = messagesButton.isSelected
```
- åº•éƒ¨å¯¼èˆªæ çš„æŒ‰é’®æœ‰`isSelected`å±æ€§
- `true` = å½“å‰é€‰ä¸­çš„Tab
- `false` = æœªé€‰ä¸­çš„Tab

#### 2. **æ™ºèƒ½åˆ¤æ–­é€»è¾‘**
```kotlin
if (messagesButton != null) {
    // åœ¨ä¸»é¡µé¢,æ£€æŸ¥æ˜¯å¦åœ¨æ¶ˆæ¯Tab
    if (isSelected) {
        // å·²åœ¨æ¶ˆæ¯é¡µé¢,ç›´æ¥ç»§ç»­
    } else {
        // åœ¨å…¶ä»–Tab,ç‚¹å‡»åˆ‡æ¢
    }
} else {
    // ä¸åœ¨ä¸»é¡µé¢,æŒ‰è¿”å›é”®è¿”å›
}
```

#### 3. **é‡è¯•æœºåˆ¶**
```kotlin
// å¯¼èˆªé‡è¯•è®¡æ•°å™¨
private var navigateRetryCount = 0
private val MAX_NAVIGATE_RETRY = 5

// é‡è¯•é€»è¾‘
if (retryCount >= MAX_NAVIGATE_RETRY) {
    stopProcessing()
    return
}
performGlobalAction(GLOBAL_ACTION_BACK)
handler.postDelayed({
    navigateToMessages(retryCount + 1)
}, 1500)
```

#### 4. **å»¶è¿Ÿæ—¶é—´ä¼˜åŒ–**
- **å·²åœ¨æ¶ˆæ¯é¡µé¢**: å»¶è¿Ÿ1ç§’ - æ— éœ€åˆ‡æ¢,å¿«é€Ÿç»§ç»­
- **éœ€è¦åˆ‡æ¢Tab**: å»¶è¿Ÿ1.5ç§’ - ç­‰å¾…Tabåˆ‡æ¢åŠ¨ç”»
- **è¿”å›ä¸»é¡µé¢**: å»¶è¿Ÿ1.5ç§’ - ç­‰å¾…è¿”å›åŠ¨ç”»

### ğŸ“Š æµ‹è¯•ç»“æœ

**æµ‹è¯•åœºæ™¯1 - å·²åœ¨æ¶ˆæ¯é¡µé¢:**
```
âœ… æ‰¾åˆ°æ¶ˆæ¯æŒ‰é’®, isSelected=true
âœ… å·²ç»åœ¨æ¶ˆæ¯é¡µé¢,ç›´æ¥æ‰“å¼€ç´ æåº“èŠå¤©
â° å‡†å¤‡åœ¨1ç§’åæ‰“å¼€ç´ æåº“èŠå¤©
âœ… æˆåŠŸæ‰§è¡Œ!
```

**æµ‹è¯•åœºæ™¯2 - åœ¨é€šè®¯å½•é¡µé¢:**
```
ğŸ” æ‰¾åˆ°æ¶ˆæ¯æŒ‰é’®, isSelected=false
âš ï¸ ä¸åœ¨æ¶ˆæ¯é¡µé¢,ç‚¹å‡»æ¶ˆæ¯æŒ‰é’®åˆ‡æ¢
â° å‡†å¤‡åœ¨1.5ç§’åæ‰“å¼€ç´ æåº“èŠå¤©
âœ… æˆåŠŸæ‰§è¡Œ!
```

**æµ‹è¯•åœºæ™¯3 - åœ¨èŠå¤©è¯¦æƒ…é¡µ:**
```
âš ï¸ æœªæ‰¾åˆ°æ¶ˆæ¯æŒ‰é’®,ä¸åœ¨ä¸»é¡µé¢
ğŸ“± æŒ‰è¿”å›é”®è¿”å›ä¸»é¡µé¢ (ç¬¬1æ¬¡å°è¯•)
ğŸ“± å¯¼èˆªåˆ°æ¶ˆæ¯é¡µé¢ (é‡è¯•æ¬¡æ•°: 1/5)
ğŸ” æ‰¾åˆ°æ¶ˆæ¯æŒ‰é’®, isSelected=false
âš ï¸ ä¸åœ¨æ¶ˆæ¯é¡µé¢,ç‚¹å‡»æ¶ˆæ¯æŒ‰é’®åˆ‡æ¢
âœ… æˆåŠŸæ‰§è¡Œ!
```

### ğŸ‰ ä¼˜åŒ–æ•ˆæœ

**ä¼˜åŒ–å‰:**
- âŒ å¿…é¡»æ‰‹åŠ¨ç¡®ä¿åœ¨æ¶ˆæ¯é¡µé¢
- âŒ åœ¨å…¶ä»–é¡µé¢å¯åŠ¨ä¼šå¤±è´¥
- âŒ ç”¨æˆ·ä½“éªŒå·®

**ä¼˜åŒ–å:**
- âœ… è‡ªåŠ¨è¯†åˆ«å½“å‰é¡µé¢
- âœ… è‡ªåŠ¨å¯¼èˆªåˆ°æ¶ˆæ¯é¡µé¢
- âœ… æ”¯æŒä»ä»»ä½•é¡µé¢å¯åŠ¨
- âœ… ç”¨æˆ·ä½“éªŒæä½³

### ğŸ”§ å…³é”®æ”¹è¿›ç‚¹

1. **ç§»é™¤äº†ç›´æ¥æ‰“å¼€ç´ æåº“èŠå¤©çš„é€»è¾‘** - è¿™æ˜¯å¯¼è‡´å¤±è´¥çš„æ ¹æœ¬åŸå› 
2. **å¼ºåˆ¶è¿”å›ä¸»é¡µé¢** - æ‰¾ä¸åˆ°"æ¶ˆæ¯"æŒ‰é’®æ—¶,å¿…é¡»å…ˆè¿”å›ä¸»é¡µé¢
3. **å¢åŠ é‡è¯•æœºåˆ¶** - æœ€å¤šé‡è¯•5æ¬¡,é¿å…æ— é™å¾ªç¯
4. **é‡ç½®é‡è¯•è®¡æ•°å™¨** - æˆåŠŸæ‰¾åˆ°"æ¶ˆæ¯"æŒ‰é’®æ—¶é‡ç½®è®¡æ•°å™¨

### ğŸ’¡ ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ‰“å¼€ç´ æåº“èŠå¤©?

**é”™è¯¯çš„é€»è¾‘:**
```kotlin
if (messagesButton == null) {
    // æ‰¾ä¸åˆ°"æ¶ˆæ¯"æŒ‰é’®,å°è¯•ç›´æ¥æ‰“å¼€ç´ æåº“èŠå¤©
    openMaterialChat()  // âŒ é—®é¢˜!å¯èƒ½è¿˜åœ¨èŠå¤©è¯¦æƒ…é¡µ
}
```

**é—®é¢˜åˆ†æ:**
- åœ¨èŠå¤©è¯¦æƒ…é¡µæ—¶,åº•éƒ¨å¯¼èˆªæ ä¸å¯è§
- æ­¤æ—¶`messagesButton == null`
- ä½†æ˜¯ç›´æ¥æ‰“å¼€ç´ æåº“èŠå¤©ä¼šå¤±è´¥,å› ä¸ºè¿˜åœ¨èŠå¤©è¯¦æƒ…é¡µçš„ä¸Šä¸‹æ–‡ä¸­
- åç»­æ“ä½œ(é•¿æŒ‰ã€å¤šé€‰)éƒ½ä¼šå¤±è´¥

**æ­£ç¡®çš„é€»è¾‘:**
```kotlin
if (messagesButton == null) {
    // æ‰¾ä¸åˆ°"æ¶ˆæ¯"æŒ‰é’®,è¯´æ˜ä¸åœ¨ä¸»é¡µé¢
    // å¿…é¡»å…ˆè¿”å›ä¸»é¡µé¢!
    performGlobalAction(GLOBAL_ACTION_BACK)
    handler.postDelayed({
        navigateToMessages(retryCount + 1)  // é‡è¯•
    }, 1500)
}
```

### ğŸ“ ç›¸å…³ä»£ç ä½ç½®

- `BatchSendService.kt` ç¬¬228-309è¡Œ - `navigateToMessages()`æ–¹æ³•
- `BatchSendService.kt` ç¬¬228-230è¡Œ - é‡è¯•è®¡æ•°å™¨å˜é‡

### ğŸš€ ä½¿ç”¨å»ºè®®

1. **æ— éœ€æ‰‹åŠ¨æ“ä½œ** - ç›´æ¥ç‚¹å‡»"å¼€å§‹æ‰¹é‡å‘é€",è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†
2. **ä»»ä½•é¡µé¢éƒ½å¯ä»¥** - åœ¨é€šè®¯å½•ã€å·¥ä½œå°ã€èŠå¤©è¯¦æƒ…ç­‰ä»»ä½•é¡µé¢éƒ½èƒ½æ­£å¸¸å¯åŠ¨
3. **è§‚å¯Ÿæ—¥å¿—** - å¯ä»¥é€šè¿‡æ—¥å¿—æŸ¥çœ‹è‡ªåŠ¨å¯¼èˆªçš„è¿‡ç¨‹

---

[è¿”å›README](../README.md)
